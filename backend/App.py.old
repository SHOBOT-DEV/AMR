from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
import jwt
import datetime
from functools import wraps
from werkzeug.security import generate_password_hash, check_password_hash


app = Flask(__name__)
CORS(app)  # Enable CORS for all routes

app.config["SECRET_KEY"] = "your-secret-key-here"  # Change this to a strong secret
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///users.db"  # SQLite DB for simplicity
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False

db = SQLAlchemy(app)


class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    role = db.Column(db.String(20), default="user")
    approval = db.Column(db.String(20), default="Pending")
    company = db.Column(db.String(100), nullable=True)
    amr_type = db.Column(db.String(50), nullable=True)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)


# Create the database tables and create default admin user if it doesn't exist
with app.app_context():
    db.create_all()
    # Create default admin user if it doesn't exist
    admin_user = User.query.filter_by(username="admin").first()
    if not admin_user:
        admin_user = User(
            username="admin",
            email="admin@admin.com",
            password_hash=generate_password_hash("admin123"),
            role="admin",
            approval="Approved",
        )
        db.session.add(admin_user)
        db.session.commit()
        print("Default admin user created: username='admin', password='admin123'")


def token_required(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        token = request.headers.get("Authorization")
        if not token:
            return jsonify({"message": "Token is missing!"}), 401

        if token.startswith("Bearer "):
            token = token.split(" ")[1]

        try:
            decoded = jwt.decode(token, app.config["SECRET_KEY"], algorithms=["HS256"])
            current_user = decoded.get("user")
            user_role = decoded.get("role")
        except jwt.ExpiredSignatureError:
            return jsonify({"message": "Token has expired!"}), 401
        except jwt.InvalidTokenError:
            return jsonify({"message": "Token is invalid!"}), 401

        return func(current_user, user_role, *args, **kwargs)

    return wrapper


@app.route("/api/register", methods=["POST"])
def register():
    try:
        # try parse JSON first, allow silent so it returns None if not JSON
        data = request.get_json(silent=True)
        if not data:
            # fallback to form-encoded data (e.g. application/x-www-form-urlencoded)
            data = request.form.to_dict() if request.form else {}

        # Debugging info (check your server logs when POST fails)
        app.logger.debug("Register request headers: %s", dict(request.headers))
        app.logger.debug("Register request data: %s", data)

        if not data:
            return jsonify(
                {
                    "message": "No JSON body received. Ensure Content-Type: application/json",
                    "success": False,
                }
            ), 400

        username = data.get("username")
        email = data.get("email")
        password = data.get("password")
        company = data.get("company")
        amr_type = data.get("amrType")

        if not username or not email or not password:
            return jsonify(
                {"message": "Missing username, email or password", "success": False}
            ), 400

        if User.query.filter(
            (User.username == username) | (User.email == email)
        ).first():
            return jsonify(
                {"message": "Username or email already exists!", "success": False}
            ), 400

        user = User(
            username=username,
            email=email,
            password_hash=generate_password_hash(password),
            role="user",
            approval="Pending",
            company=company,
            amr_type=amr_type,
        )
        db.session.add(user)
        db.session.commit()

        return jsonify({"message": "Registration successful!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/register")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/login", methods=["POST"])
def login():
    try:
        data = request.get_json(silent=True)
        if not data:
            data = request.form.to_dict() if request.form else {}

        # Debugging info
        app.logger.debug("Login request headers: %s", dict(request.headers))
        app.logger.debug("Login request data: %s", data)

        if not data:
            return jsonify(
                {
                    "message": "No JSON body received. Ensure Content-Type: application/json",
                    "success": False,
                }
            ), 400

        username = data.get("username")
        password = data.get("password")

        if not username or not password:
            return jsonify(
                {"message": "Missing username or password", "success": False}
            ), 400

        user = User.query.filter_by(username=username).first()
        if user and user.check_password(password):
            # Check if user is approved (admin can always login)
            if user.role != "admin" and user.approval != "Approved":
                return jsonify(
                    {
                        "message": "Your account is pending approval. Please wait for admin approval.",
                        "success": False,
                    }
                ), 403

            token = jwt.encode(
                {
                    "user": user.username,
                    "role": user.role,
                    "exp": datetime.datetime.utcnow() + datetime.timedelta(hours=24),
                },
                app.config["SECRET_KEY"],
                algorithm="HS256",
            )

            # ensure token is a string (pyjwt may return bytes on some versions)
            if isinstance(token, bytes):
                token = token.decode("utf-8")

            return jsonify(
                {
                    "token": token,
                    "user": {
                        "username": user.username,
                        "role": user.role,
                        "approval": user.approval,
                    },
                    "success": True,
                }
            )

        return jsonify({"message": "Invalid credentials!", "success": False}), 401
    except Exception as e:
        app.logger.exception("Error in /api/login")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/protected", methods=["GET"])
@token_required
def protected(current_user, user_role):
    return jsonify({"message": f"Hello {current_user}, this is a protected route!"})


@app.route("/api/public", methods=["GET"])
def public():
    return jsonify({"message": "This is a public route!"})


@app.route("/api/admin/users", methods=["GET"])
@token_required
def get_users(current_user, user_role):
    if user_role != "admin":
        return jsonify({"message": "Admin access required!"}), 403

    users = User.query.all()
    users_list = [
        {
            "id": u.id,
            "username": u.username,
            "email": u.email,
            "role": u.role,
            "approval": u.approval,
            "company": u.company,
            "amr_type": u.amr_type,
        }
        for u in users
    ]
    return jsonify(users_list)


@app.route("/api/admin/users/<int:user_id>/approve", methods=["PUT"])
@token_required
def approve_user(current_user, user_role, user_id):
    if user_role != "admin":
        return jsonify({"message": "Admin access required!"}), 403

    try:
        user = User.query.get(user_id)
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        user.approval = "Approved"
        db.session.commit()

        return jsonify({"message": "User approved successfully!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/admin/users/<id>/approve")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/admin/users/<int:user_id>/reject", methods=["PUT"])
@token_required
def reject_user(current_user, user_role, user_id):
    if user_role != "admin":
        return jsonify({"message": "Admin access required!"}), 403

    try:
        user = User.query.get(user_id)
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        user.approval = "Rejected"
        db.session.commit()

        return jsonify({"message": "User rejected successfully!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/admin/users/<id>/reject")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/admin/users/<int:user_id>", methods=["DELETE"])
@token_required
def delete_user(current_user, user_role, user_id):
    if user_role != "admin":
        return jsonify({"message": "Admin access required!"}), 403

    try:
        user = User.query.get(user_id)
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        # Prevent admin from deleting themselves
        if user.username == current_user:
            return jsonify(
                {"message": "Cannot delete your own account!", "success": False}
            ), 400

        db.session.delete(user)
        db.session.commit()

        return jsonify({"message": "User deleted successfully!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/admin/users/<id> DELETE")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/user/profile", methods=["GET"])
@token_required
def get_user_profile(current_user, user_role):
    try:
        user = User.query.filter_by(username=current_user).first()
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        return jsonify(
            {
                "username": user.username,
                "email": user.email,
                "role": user.role,
                "approval": user.approval,
                "company": user.company,
                "amr_type": user.amr_type,
                "success": True,
            }
        )
    except Exception as e:
        app.logger.exception("Error in /api/user/profile")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/user/profile", methods=["PUT"])
@token_required
def update_user_profile(current_user, user_role):
    try:
        data = request.get_json(silent=True)
        if not data:
            data = request.form.to_dict() if request.form else {}

        user = User.query.filter_by(username=current_user).first()
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        # Update allowed fields
        if "email" in data:
            # Check if email is already taken by another user
            existing_user = User.query.filter(
                User.email == data["email"], User.id != user.id
            ).first()
            if existing_user:
                return jsonify(
                    {"message": "Email already in use!", "success": False}
                ), 400
            user.email = data["email"]

        if "company" in data:
            user.company = data["company"]

        if "amr_type" in data:
            user.amr_type = (
                data["amrType"] if "amrType" in data else data.get("amr_type")
            )

        db.session.commit()

        return jsonify({"message": "Profile updated successfully!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/user/profile PUT")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/user/password", methods=["PUT"])
@token_required
def update_password(current_user, user_role):
    try:
        data = request.get_json(silent=True)
        if not data:
            data = request.form.to_dict() if request.form else {}

        old_password = data.get("oldPassword")
        new_password = data.get("newPassword")

        if not old_password or not new_password:
            return jsonify(
                {"message": "Old password and new password required!", "success": False}
            ), 400

        user = User.query.filter_by(username=current_user).first()
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        if not user.check_password(old_password):
            return jsonify(
                {"message": "Incorrect old password!", "success": False}
            ), 401

        user.password_hash = generate_password_hash(new_password)
        db.session.commit()

        return jsonify({"message": "Password updated successfully!", "success": True})
    except Exception as e:
        app.logger.exception("Error in /api/user/password")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/api/verify-token", methods=["GET"])
@token_required
def verify_token(current_user, user_role):
    """Verify if the token is valid and return user info"""
    try:
        user = User.query.filter_by(username=current_user).first()
        if not user:
            return jsonify({"message": "User not found!", "success": False}), 404

        return jsonify(
            {
                "valid": True,
                "user": {
                    "username": user.username,
                    "email": user.email,
                    "role": user.role,
                    "approval": user.approval,
                },
                "success": True,
            }
        )
    except Exception as e:
        app.logger.exception("Error in /api/verify-token")
        return jsonify(
            {"message": "Server error", "detail": str(e), "success": False}
        ), 500


@app.route("/")
def home():
    return "Hello, Flask is running!"


if __name__ == "__main__":
    app.run(debug=True, port=5000)
